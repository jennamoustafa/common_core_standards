---
title: "Milestone 6"
author: "Jenna Moustafa"
date: "3/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 15)
library(tidyverse)
library(readxl)
library(janitor)
library(tm)
library(writexl)

# Read in fourth grade reading scores by state and year, keeping only
# observation rows

fourth_reading <- read_xlsx(path = "raw-data/fourth_reading_naep.xlsx",
                            skip = 7, n_max = 531) %>%
  
  # Make column names easy to use, so that there are no spaces
  
  clean_names() %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "fourth") %>%
  mutate(subject = "reading") %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "average_scale_score")

# Read in fourth grade math scores by state and year, keeping only
# observation rows

fourth_math <- read_xlsx(path = "raw-data/fourth_math_naep.xlsx",
                         skip = 7, n_max = 531) %>%
  
  # Make column names easy to use, so that there are no spaces

  clean_names() %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "fourth") %>%
  mutate(subject = "math") %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "average_scale_score")

# Read in eighth grade reading scores by state and year, keeping only
# observation rows

eighth_reading <- read_xlsx(path = "raw-data/eighth_reading_naep.xlsx",
                            skip = 7, n_max = 531) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Make column names easy to use, so that there are no spaces
  
  clean_names() %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "eighth") %>%
  mutate(subject = "reading") %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "average_scale_score")

# Read in eighth grade math scores by state and year, keeping only
# observation rows

eighth_math <- read_xlsx(path = "raw-data/eighth_math_naep.xlsx",
                         skip = 7, n_max = 531) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Make column names easy to use, so that there are no spaces
  
  clean_names() %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "eighth") %>%
  mutate(subject = "math") %>%
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "average_scale_score")

# Read in high school graduation rates by state and year, keeping only
# observation rows for years graduating years 2011, 2012, and 2013
# replacing dash with NA, and renaming columns so they are not just numeric

grad_rate_2011_2013 <- read_excel("raw-data/grad_rate_2011_2013.xlsx",
                                  col_names = c("state", "grad_2011",
                                                "grad_2012", "notes",
                                                "grad_2013"),
                                  na = "—", skip = 5, n_max = 52) %>%
  
  # Make column names easy to use, so that there are no spaces
  
  clean_names() %>%
  
  # Remove column with useless info
  
  select("state", "grad_2011", "grad_2012", "grad_2013") %>% 
  
  # Fix state cells that have numbers included from footnotes
  
  mutate(state = removeNumbers(state))
```

```{r, echo = FALSE}
# Join fourth grade reading and math scores together so that each table is on 
# top of each other
fourth <- fourth_reading %>% 
  full_join(fourth_math, by = c("year", "jurisdiction", "grade", "subject",
                                "average_scale_score"))

# Join eighth grade reading and math scores together so that each table is on 
# top of each other

eighth <- eighth_reading %>% 
  full_join(eighth_math, by = c("year", "jurisdiction", "grade", "subject",
                                "average_scale_score"))

# Join eighth grade and fourth grade scores together so that all tables are on 
# top of each other

naep <- fourth %>% 
  full_join(eighth,  by = c("year", "jurisdiction", "grade", "subject",
                                "average_scale_score")) %>% 
  mutate(score = as.numeric(average_scale_score)) %>% 
  mutate(test_type = case_when(grade == "fourth" &
                                 subject == "reading" ~ "fourth reading",
                               grade == "fourth" &
                                 subject == "math" ~ "fourth math",
                               grade == "eighth" &
                                 subject == "reading" ~ "eighth reading",
                               grade == "eighth" &
                                 subject == "math" ~ "eighth math"))
```

```{r}
### Repeat above steps for subgroups in each grade and subject
## Fourth grade reading scores
## Race

fourth_reading_race <- read_xlsx(path = "raw-data/fourth_reading_race.xlsx",
                            skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces
  
  clean_names() %>%
    
  # Remove NA observations
  
  filter(!is.na(year)) %>% 
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "fourth",
         subject = "reading",
         score = as.numeric(average_scale_score)) %>% 
  
  # Rename subgroup column name

  rename(race = race_ethnicity_used_to_report_trends_school_reported) %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "race", "score")

## Ethnicity

fourth_reading_ethn <- read_xlsx(path = "raw-data/fourth_reading_ethn.xlsx",
                         skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces

  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "fourth",
         subject = "reading",
         score = as.numeric(average_scale_score)) %>%  
  
  # Rename subgroup column name

  rename(ethnicity = race_ethnicity_using_2011_guidelines_school_reported) %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "ethnicity", "score")

## Gender

fourth_reading_gender <- read_xlsx(path = "raw-data/fourth_reading_gender.xlsx",
                            skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces
  
  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "fourth",
         subject = "reading",
         score = as.numeric(average_scale_score)) %>%  
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "gender", "score")

# Read in fourth grade math scores by state and year, keeping only
# observation rows

fourth_reading_lunch <- read_xlsx(path = "raw-data/fourth_reading_lunch.xlsx",
                         skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces

  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "fourth",
         subject = "reading",
         score = as.numeric(average_scale_score)) %>%  
  
  # Rename subgroup column name
  
  rename(school_lunch = national_school_lunch_program_eligibility_3_categories) %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "school_lunch", "score")

# Join fourth grade reading subgroup scores together so that each table is on 
# top of each other

fourth_reading_sub <- fourth_reading_race %>% 
  full_join(fourth_reading_ethn, by = c("year", "jurisdiction", "grade", "subject",
                                "score")) %>% 
  full_join(fourth_reading_gender, by = c("year", "jurisdiction", "grade", "subject",
                                "score")) %>% 
  full_join(fourth_reading_lunch, by = c("year", "jurisdiction", "grade", "subject",
                                "score")) %>% 
  select(-score, everything())
```


```{r}
### Repeat above steps for subgroups in each grade and subject
## Fourth grade math scores
## Race

fourth_math_race <- read_xlsx(path = "raw-data/fourth_math_race.xlsx",
                            skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces
  
  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "fourth",
         subject = "math",
         score = as.numeric(average_scale_score)) %>% 
  
  # Rename subgroup column name

  rename(race = race_ethnicity_used_to_report_trends_school_reported) %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "race", "score")

## Ethnicity

fourth_math_ethn <- read_xlsx(path = "raw-data/fourth_math_ethn.xlsx",
                         skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces

  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "fourth",
         subject = "math",
         score = as.numeric(average_scale_score)) %>%  
  
  # Rename subgroup column name

  rename(ethnicity = race_ethnicity_using_2011_guidelines_school_reported) %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "ethnicity", "score")

## Gender

fourth_math_gender <- read_xlsx(path = "raw-data/fourth_math_gender.xlsx",
                            skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces
  
  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "fourth",
         subject = "math",
         score = as.numeric(average_scale_score)) %>%  
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "gender", "score")

# Read in fourth grade math scores by state and year, keeping only
# observation rows

fourth_math_lunch <- read_xlsx(path = "raw-data/fourth_math_lunch.xlsx",
                         skip = 7, n_max = 531) %>%
  
  # Make column names easy to use, so that there are no spaces

  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "fourth",
         subject = "math",
         score = as.numeric(average_scale_score)) %>%  
  
  # Rename subgroup column name
  
  rename(school_lunch = national_school_lunch_program_eligibility_3_categories) %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "school_lunch", "score")

# Join fourth grade reading subgroup scores together so that each table is on 
# top of each other

fourth_math_sub <- fourth_math_race %>% 
  full_join(fourth_math_ethn, by = c("year", "jurisdiction", "grade", "subject",
                                "score")) %>% 
  full_join(fourth_math_gender, by = c("year", "jurisdiction", "grade", "subject",
                                "score")) %>% 
  full_join(fourth_math_lunch, by = c("year", "jurisdiction", "grade", "subject",
                                "score")) %>% 
  select(-score, everything())
```


```{r}
### Repeat above steps for subgroups in each grade and subject
## Eighth grade reading scores
## Race

eighth_reading_race <- read_xlsx(path = "raw-data/eighth_reading_race.xlsx",
                            skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces
  
  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "eighth",
         subject = "reading",
         score = as.numeric(average_scale_score)) %>% 
  
  # Rename subgroup column name

  rename(race = race_ethnicity_used_to_report_trends_school_reported) %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "race", "score")

## Ethnicity

eighth_reading_ethn <- read_xlsx(path = "raw-data/eighth_reading_ethn.xlsx",
                         skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces

  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "eighth",
         subject = "reading",
         score = as.numeric(average_scale_score)) %>%  
  
  # Rename subgroup column name

  rename(ethnicity = race_ethnicity_using_2011_guidelines_school_reported) %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "ethnicity", "score")

## Gender

eighth_reading_gender <- read_xlsx(path = "raw-data/eighth_reading_gender.xlsx",
                            skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces
  
  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "eighth",
         subject = "reading",
         score = as.numeric(average_scale_score)) %>%  
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "gender", "score")

## Lunch

eighth_reading_lunch <- read_xlsx(path = "raw-data/eighth_reading_lunch.xlsx",
                         skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces

  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "eighth",
         subject = "reading",
         score = as.numeric(average_scale_score)) %>%  
  
  # Rename subgroup column name
  
  rename(school_lunch = national_school_lunch_program_eligibility_3_categories) %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "school_lunch", "score")

# Join fourth grade reading subgroup scores together so that each table is on 
# top of each other

eighth_reading_sub <- eighth_reading_race %>% 
  full_join(eighth_reading_ethn, by = c("year", "jurisdiction", "grade", "subject",
                                "score")) %>% 
  full_join(eighth_reading_gender, by = c("year", "jurisdiction", "grade", "subject",
                                "score")) %>% 
  full_join(eighth_reading_lunch, by = c("year", "jurisdiction", "grade", "subject",
                                "score")) %>% 
  select(-score, everything())
```


```{r}
### Repeat above steps for subgroups in each grade and subject
## Eighth grade math scores
## Race

eighth_math_race <- read_xlsx(path = "raw-data/eighth_math_race.xlsx",
                            skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces
  
  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "eighth",
         subject = "math",
         score = as.numeric(average_scale_score)) %>% 
  
  # Rename subgroup column name

  rename(race = race_ethnicity_used_to_report_trends_school_reported) %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "race", "score")

## Ethnicity

eighth_math_ethn <- read_xlsx(path = "raw-data/eighth_math_ethn.xlsx",
                         skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces

  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "eighth",
         subject = "math",
         score = as.numeric(average_scale_score)) %>%  
  
  # Rename subgroup column name

  rename(ethnicity = race_ethnicity_using_2011_guidelines_school_reported) %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "ethnicity", "score")

## Gender

eighth_math_gender <- read_xlsx(path = "raw-data/eighth_math_gender.xlsx",
                            skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces
  
  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "eighth",
         subject = "math",
         score = as.numeric(average_scale_score)) %>%  
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "gender", "score")

# Read in fourth grade math scores by state and year, keeping only
# observation rows

eighth_math_lunch <- read_xlsx(path = "raw-data/eighth_math_lunch.xlsx",
                         skip = 7) %>%
  
  # Make column names easy to use, so that there are no spaces

  clean_names() %>%
  
  # Remove NA observations
  
  filter(!is.na(year)) %>%
  
  # Replace symbols with NA
  
  na_if(.,"‡") %>%
  na_if(., "—") %>%
  
  # Create columns for grade and subjects
  
  mutate(grade = "eighth",
         subject = "math",
         score = as.numeric(average_scale_score)) %>%  
  
  # Rename subgroup column name
  
  rename(school_lunch = national_school_lunch_program_eligibility_3_categories) %>% 
  
  # Remove column with useless info and reorganize column so score is last
  
  select("year", "jurisdiction", "grade", "subject", "school_lunch", "score")

# Join fourth grade reading subgroup scores together so that each table is on 
# top of each other

eighth_math_sub <- eighth_math_race %>% 
  full_join(eighth_math_ethn, by = c("year", "jurisdiction", "grade", "subject",
                                "score")) %>% 
  full_join(eighth_math_gender, by = c("year", "jurisdiction", "grade", "subject",
                                "score")) %>% 
  full_join(eighth_math_lunch, by = c("year", "jurisdiction", "grade", "subject",
                                "score")) %>% 
  select(-score, everything())
```

```{r, echo = FALSE}
# Join fourth grade reading and math scores together so that each table is on 
# top of each other
fourth_sub <- fourth_reading_sub %>% 
  full_join(fourth_math_sub, by = c("year", "jurisdiction", "grade", "subject",
                                "score", "race", "ethnicity", "gender",
                                "school_lunch"))

# Join eighth grade reading and math scores together so that each table is on 
# top of each other

eighth_sub <- eighth_reading_sub %>% 
  full_join(eighth_math_sub, by = c("year", "jurisdiction", "grade", "subject",
                                "score", "race", "ethnicity", "gender",
                                "school_lunch"))

# Join eighth grade and fourth grade scores together so that all tables are on 
# top of each other

naep_sub <- fourth_sub %>% 
  full_join(eighth_sub,  by = c("year", "jurisdiction", "grade", "subject",
                                "score", "race", "ethnicity", "gender",
                                "school_lunch")) %>%
  mutate(test_type = case_when(grade == "fourth" &
                                 subject == "reading" ~ "fourth reading",
                               grade == "fourth" &
                                 subject == "math" ~ "fourth math",
                               grade == "eighth" &
                                 subject == "reading" ~ "eighth reading",
                               grade == "eighth" &
                                 subject == "math" ~ "eighth math")) %>% 
  select(-score, everything())
```

```{r}
## Save datasets into a single file 
write_xlsx(naep_sub, path = "shiny/naep_sub.xlsx")
write_xlsx(naep, path = "shiny/naep.xlsx")
```

## Data Visualization

```{r, echo = FALSE}
naep %>% 
  filter(jurisdiction == "California") %>% 
  ggplot(., aes(year, score, color = test_type)) + 
  geom_point() +
  geom_vline(xintercept = 2010) + 
  geom_path() +
  labs(x = "Year",
       y = "Average Test Score",
       title = "California Scores Before and After \n Common Core Implementation in 2010",
       color = "grade and subject")

ggsave("plot1.png", plot = last_plot(), path = "shiny")

```


```{r, echo = FALSE}
naep_sub %>% 
  filter(jurisdiction == "California" & !is.na(race) & !is.na(score)) %>% 
  ggplot(., aes(year, score, color = race)) + 
  geom_point() +
  facet_wrap(vars(test_type)) +
  geom_vline(xintercept = 2010) + 
  geom_path() +
  labs(x = "Year",
       y = "Average Test Score",
       title = "California Scores Before and After \n Common Core Implementation in 2010 by Race",
       color = "Race")


ggsave("plot2.png", plot = last_plot(), path = "shiny")
```

## Background
The goal of this project is to determine how implementation of the common core
in California in 2010 affected achievement relative to other states which
did not adopt the common core curriculum. The goal of the curriculum
standardization is to narrow achievement gaps; however, there is debate over
whether the common core actually achieved this goal or states simply adjusted
their state standardized tests to allow for teachers' teaching to the test.
To avoid this bias, I am using National Assessment of Educational Progress data
which includes average student test scores by states on national standardized
exams.

## Data
The data from this project is from nce.ed.gov and nationsreportcard.gov, which 
has data on test scores by state and year for fourth and eighth grade and
yearly high school graduation data respectively. I cleaned all of the data, and
combined the test scores for eighth grade reading, eighth grade math, fourth
grade reading, and fourth grade math into one table. I might need to gather
graduation data for more years before and after implementation of the 
Common Core for greater robustness. 

## Project Plan
The plan for this project is to do an event study design looking at test scores
before and after implementation in California relative to the states that did
not implement the curriculum as well as graduation data in the years after
implementation.
